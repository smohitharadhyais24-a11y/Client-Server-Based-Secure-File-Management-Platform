# ğŸ—ï¸ SYSTEM ARCHITECTURE & DESIGN

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Terminal 1 â”‚  â”‚  Terminal 2 â”‚  â”‚  Terminal 3 â”‚         â”‚
â”‚  â”‚   Client    â”‚  â”‚   Client    â”‚  â”‚   Client    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â”‚   TCP Socket (Port 8888) - IPC    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SERVER LAYER (C)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Main Server Process                      â”‚  â”‚
â”‚  â”‚  - socket(), bind(), listen(), accept()              â”‚  â”‚
â”‚  â”‚  - Infinite loop waiting for connections             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                                           â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚      â”‚                      â”‚             â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Thread 1â”‚         â”‚ Thread 2 â”‚    â”‚ Thread 3â”‚          â”‚
â”‚  â”‚ (Client1)â”‚        â”‚(Client2) â”‚    â”‚(Client3)â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â”‚
â”‚       â”‚                    â”‚              â”‚               â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚       â”‚  â”‚     File Operation Handlers     â”‚            â”‚  â”‚
â”‚       â””â”€â”€â–º  - handle_upload()              â”‚            â”‚  â”‚
â”‚          â”‚  - handle_download()            â”‚            â”‚  â”‚
â”‚          â”‚  - handle_list()                â”‚            â”‚  â”‚
â”‚          â”‚  - handle_delete()              â”‚            â”‚  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   OS SYSTEM CALL LAYER                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  File I/O    â”‚ â”‚  Locking   â”‚ â”‚  Synchronizationâ”‚       â”‚
â”‚  â”‚  - open()    â”‚ â”‚  - fcntl() â”‚ â”‚  - pthread      â”‚       â”‚
â”‚  â”‚  - read()    â”‚ â”‚  - F_SETLK â”‚ â”‚  - mutex        â”‚       â”‚
â”‚  â”‚  - write()   â”‚ â”‚  - F_RDLCK â”‚ â”‚                 â”‚       â”‚
â”‚  â”‚  - stat()    â”‚ â”‚  - F_WRLCK â”‚ â”‚                 â”‚       â”‚
â”‚  â”‚  - unlink()  â”‚ â”‚            â”‚ â”‚                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LINUX KERNEL                              â”‚
â”‚  - Process Scheduler                                        â”‚
â”‚  - File System (ext4)                                       â”‚
â”‚  - Lock Manager                                             â”‚
â”‚  - Network Stack                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PHYSICAL STORAGE                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ storage/ â”‚  â”‚metadata/ â”‚  â”‚  logs/   â”‚                 â”‚
â”‚  â”‚  files   â”‚  â”‚  .meta   â”‚  â”‚audit.log â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Interactions

### 1. Connection Flow

```
Client                     Server                    OS Kernel
  |                          |                           |
  |------ connect() -------->|                           |
  |                          |---- accept() ------------>|
  |                          |<--- new socket -----------|
  |                          |---- pthread_create() ---->|
  |                          |<--- Thread ID ------------|
  |<----- ACK --------------|                           |
  |                          |                           |
```

---

### 2. Upload Flow (Deadlock Prevention)

```
Client                    Server Thread              Filesystem
  |                           |                          |
  |-- UPLOAD file.txt 1024 -->|                          |
  |                           |--- parse command         |
  |                           |--- open(file) ---------->|
  |                           |<-- fd -------------------|
  |                           |                          |
  |                           |--- fcntl(F_WRLCK) ------>|
  |                           |<-- SUCCESS --------------|
  |                           | [LOCK ACQUIRED]          |
  |<----- READY -------------|                          |
  |                           |                          |
  |=== Send 1024 bytes =====>|                          |
  |    [BOUNDED TRANSFER]    |--- write(fd, data) ----->|
  |                           |<-- bytes written --------|
  |                           | [Repeat until 1024 bytes]|
  |                           |                          |
  |                           |--- fcntl(F_UNLCK) ------>|
  |                           |<-- SUCCESS --------------|
  |                           | [LOCK RELEASED]          |
  |                           |                          |
  |                           |--- update_metadata()     |
  |                           |--- write_audit_log()     |
  |                           |                          |
  |<--- SUCCESS -------------|                          |
  |                           |                          |
```

**Key Points:**
- âœ… File size sent BEFORE data (bounded transfer)
- âœ… Lock acquired BEFORE write
- âœ… Lock released IMMEDIATELY after write
- âœ… Metadata/logging OUTSIDE critical section

---

### 3. Concurrent Upload (Deadlock Avoidance)

```
Client 1                 Client 2              Server
  |                        |                      |
  |--- UPLOAD file 1024 -->|                      |
  |                        |--- UPLOAD file 1024->|
  |                        |                      |
  |                    [Thread 1]            [Thread 2]
  |                        |                      |
  |                   fcntl(F_WRLCK)         fcntl(F_WRLCK)
  |                   SUCCESS                EAGAIN (locked)
  |                   [WRITING]                   |
  |                        |                      |
  |<--- SUCCESS -----  [Writing data]            |
  |                        |     ERROR: locked -->|
  |                        |                      |
```

**Key Points:**
- âœ… F_SETLK (non-blocking) returns immediately
- âœ… Client 2 rejected instantly (no wait)
- âœ… No circular wait â†’ No deadlock

---

## Thread Management Architecture

```
Main Thread (Server)
    |
    |---- accept() loop
    |
    |---- Client connects
    |
    |---- pthread_create(&thread_id, NULL, handle_client, client_info)
    |        |
    |        |---- New Thread Created
    |        |        |
    |        |        |---- handle_client()
    |        |        |        |
    |        |        |        |---- Parse command
    |        |        |        |---- Route to handler
    |        |        |        |---- handle_upload() / download() / etc.
    |        |        |        |---- close(socket)
    |        |        |        |---- Thread exits
    |        |        |
    |        |---- pthread_detach(thread_id)
    |        |     [Auto cleanup when thread exits]
    |
    |---- Continue accepting connections
```

---

## File Locking State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  UNLOCKED  â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚                â”‚
    F_RDLCK          F_WRLCK          F_RDLCK
    (Read)           (Write)          (Read)
         â”‚                â”‚                â”‚
         â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SHARED  â”‚â—„â”€â”€â”€â”€â”¤EXCLUSIVEâ”œâ”€â”€â”€â”€â”€â–ºâ”‚ SHARED  â”‚
    â”‚  LOCK   â”‚      â”‚  LOCK   â”‚      â”‚  LOCK   â”‚
    â”‚(Multipleâ”‚      â”‚(Single  â”‚      â”‚(Multipleâ”‚
    â”‚ Readers)â”‚      â”‚ Writer) â”‚      â”‚ Readers)â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                     F_UNLCK
                          â”‚
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  UNLOCKED  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Lock Compatibility Matrix:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Held   â”‚ F_RDLCK â”‚ F_WRLCK  â”‚ F_UNLCK â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚F_RDLCK â”‚   âœ“     â”‚    âœ—     â”‚    âœ“    â”‚
â”‚F_WRLCK â”‚   âœ—     â”‚    âœ—     â”‚    âœ“    â”‚
â”‚F_UNLCK â”‚   âœ“     â”‚    âœ“     â”‚    âœ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Synchronization Design

### File-Level Synchronization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         File: data.txt               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   fcntl() Lock (OS-level)      â”‚  â”‚
â”‚  â”‚   - Protects: File data        â”‚  â”‚
â”‚  â”‚   - Scope: System-wide         â”‚  â”‚
â”‚  â”‚   - Type: Advisory             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Metadata Synchronization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       metadata_mutex (pthread)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   pthread_mutex_t              â”‚  â”‚
â”‚  â”‚   - Protects: Metadata files   â”‚  â”‚
â”‚  â”‚   - Scope: Process-wide        â”‚  â”‚
â”‚  â”‚   - Type: Mandatory            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Log Synchronization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         log_mutex (pthread)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   pthread_mutex_t              â”‚  â”‚
â”‚  â”‚   - Protects: audit.log        â”‚  â”‚
â”‚  â”‚   - Scope: Process-wide        â”‚  â”‚
â”‚  â”‚   - Type: Mandatory            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Critical Section Analysis

### âœ… Correct Critical Section

```c
// MINIMAL CRITICAL SECTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fcntl(F_WRLCK)  â† Acquire lock      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ write(fd, data) â† CRITICAL SECTION  â”‚  <-- Only 1-5ms
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ fcntl(F_UNLCK)  â† Release lock      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ compute_checksum() â† Outside lock   â”‚
â”‚ update_metadata()  â† Outside lock   â”‚
â”‚ write_audit_log()  â† Outside lock   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âŒ Wrong Critical Section (Don't Do This!)

```c
// BLOATED CRITICAL SECTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fcntl(F_WRLCK)  â† Acquire lock      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ write(fd, data)                     â”‚  <-- Holding lock
â”‚ compute_checksum() â† SHOULD BE OUT  â”‚      for 100ms+
â”‚ update_metadata()  â† SHOULD BE OUT  â”‚      BAD!
â”‚ write_audit_log()  â† SHOULD BE OUT  â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ fcntl(F_UNLCK)  â† Release lock      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deadlock Prevention Strategy

### Four Necessary Conditions for Deadlock

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. MUTUAL EXCLUSION                        â”‚
â”‚    Resource can be held by one process     â”‚
â”‚    âœ“ Required for correctness              â”‚
â”‚    â†’ Cannot eliminate                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. HOLD AND WAIT                           â”‚
â”‚    Process holds resource while waiting    â”‚
â”‚    âœ— PREVENTED by bounded transfers        â”‚
â”‚    â†’ Server never waits indefinitely       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. NO PREEMPTION                           â”‚
â”‚    Resource cannot be forcibly taken       â”‚
â”‚    âœ“ Required for file integrity           â”‚
â”‚    â†’ Cannot eliminate                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. CIRCULAR WAIT                           â”‚
â”‚    Processes waiting in a cycle            â”‚
â”‚    âœ— AVOIDED by non-blocking locks         â”‚
â”‚    â†’ F_SETLK returns immediately           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RESULT: Breaking conditions 2 & 4 prevents deadlock!
```

---

## Memory Layout

```
Server Process Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Stack (per thread)          â”‚
â”‚  - Local variables                  â”‚
â”‚  - Function call frames             â”‚
â”‚  - Return addresses                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Heap (malloc)               â”‚
â”‚  - client_info_t structures         â”‚
â”‚  - Dynamic buffers                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Global Data                 â”‚
â”‚  - metadata_mutex                   â”‚
â”‚  - log_mutex                        â”‚
â”‚  - PORT, BUFFER_SIZE constants      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Code Segment                â”‚
â”‚  - main()                           â”‚
â”‚  - handle_client()                  â”‚
â”‚  - handle_upload()                  â”‚
â”‚  - etc.                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File System Layout

```
NEW OS/
â”œâ”€â”€ build/
â”‚   â””â”€â”€ file_server              (Compiled binary)
â”‚
â”œâ”€â”€ storage/                     (User files)
â”‚   â”œâ”€â”€ test1.txt               â—„â”€â”€â”€ fcntl() locks protect these
â”‚   â”œâ”€â”€ test2.txt
â”‚   â””â”€â”€ document.pdf
â”‚
â”œâ”€â”€ metadata/                    (File metadata)
â”‚   â”œâ”€â”€ test1.txt.meta          â—„â”€â”€â”€ mutex protects these
â”‚   â”œâ”€â”€ test2.txt.meta
â”‚   â””â”€â”€ document.pdf.meta
â”‚
â”œâ”€â”€ logs/                        (Audit logs)
â”‚   â””â”€â”€ audit.log               â—„â”€â”€â”€ mutex protects this
â”‚
â””â”€â”€ test_files/                  (Demo files)
    â”œâ”€â”€ test1.txt
    â”œâ”€â”€ test2.txt
    â””â”€â”€ test3.txt
```

---

## Performance Characteristics

| Operation | Time Complexity | Lock Duration |
|-----------|----------------|---------------|
| Upload    | O(n) file size | ~n/bandwidth ms |
| Download  | O(n) file size | ~n/bandwidth ms |
| List      | O(m) files     | No lock needed |
| Delete    | O(1)           | < 1ms |
| Locks     | O(m) files     | No lock needed |
| Logs      | O(log size)    | No lock needed |

**Key:** Lock held only during actual file I/O (~1-10ms for small files)

---

## Protocol Specification

### Upload Protocol

```
Client â†’ Server: "UPLOAD filename filesize\n"
Server â†’ Client: "READY Send file data\n"
Client â†’ Server: [exactly filesize bytes]
Server â†’ Client: "SUCCESS File uploaded successfully\n"
```

### Download Protocol

```
Client â†’ Server: "DOWNLOAD filename\n"
Server â†’ Client: "SUCCESS filesize\n"
Server â†’ Client: [exactly filesize bytes]
```

### List Protocol

```
Client â†’ Server: "LIST\n"
Server â†’ Client: "SUCCESS\nfile1 (1024 bytes)\nfile2 (2048 bytes)\n"
```

---

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client Request â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ Validate â”‚
    â”‚  Input   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     ERROR
    â”‚Try Lock  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚ SUCCESS        â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”          â”‚
    â”‚ Perform  â”‚          â”‚
    â”‚Operation â”‚          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚                â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”          â”‚
    â”‚ Release  â”‚          â”‚
    â”‚  Lock    â”‚          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚                â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ SUCCESS  â”‚     â”‚  ERROR   â”‚
    â”‚ Response â”‚     â”‚ Response â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## OS Concepts Mapping

| Code Component | OS Concept | Location |
|----------------|-----------|----------|
| `open()` | UNIX File I/O | handle_upload() line 250 |
| `fcntl(F_SETLK)` | Non-blocking lock | acquire_file_lock() line 505 |
| `pthread_create()` | Thread management | main() line 150 |
| `pthread_mutex_lock()` | Synchronization | write_audit_log() line 600 |
| Bounded transfer | Deadlock prevention | handle_upload() line 270 |
| F_SETLK not F_SETLKW | Deadlock avoidance | acquire_file_lock() line 510 |
| Timeout check | Deadlock recovery | handle_upload() line 280 |
| Minimal critical section | Performance optimization | handle_upload() line 320 |

---

This architecture demonstrates all major OS concepts in a clean, maintainable, and demo-friendly design!
